<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Kh√°ch S·∫°n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        h1 {
            color: #2c3e50;
        }
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
        }
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            padding: 20px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 10px;
        }
        .sidebar ul li a {
            color: white;
            text-decoration: none;
            display: block;
        }
        .content {
            flex: 1;
            padding: 20px;
        }
        .tabs {
            display: flex;
            gap: 10px;
        }
        .tab {
            padding: 10px;
            background: #16a085;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .tab.active {
            background: #1abc9c;
        }
        .tab-content {
            display: none;
            margin-top: 20px;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Qu·∫£n L√Ω Kh√°ch S·∫°n</h2>
        <ul>
            <li><a href="./phong.html">Qu·∫£n l√Ω ph√≤ng</a></li>
            <li><a href="./khachhang.html">Qu·∫£n l√Ω kh√°ch h√†ng</a></li>
            <li><a href="./nhanvien.html">Qu·∫£n l√Ω nh√¢n vi√™n</a></li>
            <li><a href="./dichvu.html">Qu·∫£n l√Ω d·ªãch v·ª•</a></li>
            <li><a href="./thuephong.html">Qu·∫£n l√Ω thu√™ ph√≤ng</a></li>
            <li><a href="./hoadon.html">Qu·∫£n l√Ω h√≥a ƒë∆°n</a></li>
            <li class="active"><a href="./timkiem.html">T√¨m ki·∫øm</a></li>
            <li><a href="./thongke.html">Th·ªëng k√™</a></li>
            <li><a href="#" id="logoutBtn" onclick="handleLogout()">ƒêƒÉng xu·∫•t</a></li>
        </ul>
    </div>
    <div class="content">
        <h1>T√¨m ki·∫øm</h1>
        <div class="tabs">
            <div class="tab active" onclick="showTab('khachhang')">Kh√°ch h√†ng</div>
            <div class="tab" onclick="showTab('nhanvien')">Nh√¢n vi√™n</div>
            <div class="tab" onclick="showTab('phong')">Ph√≤ng</div>
        </div>

        <!-- T√¨m ki·∫øm kh√°ch h√†ng -->
        <div id="khachhang" class="tab-content active">
            <label>T√™n kh√°ch h√†ng:</label>
            <input type="text" id="ten_khach_hang" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng...">
            <label>S·∫Øp x·∫øp theo</label>
            <select id="sortTenKhachHang" onchange="sortKhachHang()">
                <option value="tenAZ">T√™n A ‚Üí Z</option>
                <option value="tenZA">T√™n Z ‚Üí A</option>
            </select>

            <label for="start_date">Ng√†y nh·∫≠n:</label>
            <input type="date" id="start_date">

            <label for="end_date">Ng√†y tr·∫£:</label>
            <input type="date" id="end_date">

            <button onclick="timKiemKhachHang()">T√¨m ki·∫øm</button>
            <button onclick="xuatDSKH()">Xu·∫•t Excel</button>
            <h3>K·∫øt qu·∫£ t√¨m ki·∫øm kh√°ch h√†ng:</h3>
            <table id = "bangKhachHang">
                <thead>
                    <tr>
                        <th>M√£ Ph√≤ng</th>
                        <th>M√£ Thu√™</th>
                        <th>T√™n Kh√°ch H√†ng</th>
                        <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                        <th>Ng√†y Nh·∫≠n</th>
                        <th>Ng√†y Tr·∫£</th>
                        <th>Lo·∫°i Ph√≤ng</th>
                    </tr>
                </thead>
                <tbody id="ketQuaKhachHang"></tbody>
            </table>
        </div>

        <!-- T√¨m ki·∫øm nh√¢n vi√™n -->
        <div id="nhanvien" class="tab-content">
            <label>T√™n nh√¢n vi√™n:</label>
            <input type="text" id="ten_nhan_vien" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n...">
            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="text" id="sdt_nhan_vien" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
            <button onclick="timKiemNhanVien()">T√¨m ki·∫øm</button>
            <button onclick="xuatDSNV()">Xu·∫•t Excel</button>

            <h3>K·∫øt qu·∫£ t√¨m ki·∫øm nh√¢n vi√™n:</h3>
            <table id="bangNhanVien">
                <thead>
                    <tr>
                        <th>M√£ NV</th>
                        <th>H·ªç T√™n</th>
                        <th>Ng√†y Sinh</th>
                        <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                    </tr>
                </thead>
                <tbody id="ketQuaNhanVien"></tbody>
            </table>
        </div>

        <!-- T√¨m ki·∫øm ph√≤ng -->
        <div id="phong" class="tab-content">
            <label>S·ªë ph√≤ng:</label>
            <input type="text" id="so_phong" placeholder="Nh·∫≠p s·ªë ph√≤ng...">

            <label>Lo·∫°i ph√≤ng:</label>
            <input type="text" id="loai_phong" placeholder="Nh·∫≠p lo·∫°i ph√≤ng...">

            <label>Tr·∫°ng th√°i</label>
            <select id="trangThai" onchange="sort()">
                <option value="">T·∫•t c·∫£</option>
                <option value="trong">Tr·ªëng</option>
                <option value="dangSuDung">ƒêang s·ª≠ d·ª•ng</option>
            </select>

            <button onclick="timKiemPhong()">T√¨m ki·∫øm</button>
            <button onclick="xuatDSPhong()">Xu·∫•t Excel</button>

            <h3>K·∫øt qu·∫£ t√¨m ki·∫øm ph√≤ng:</h3>
            <table id = "bangPhong">
                <thead>
                    <tr>
                        <th>M√£ Ph√≤ng</th>
                        <th>M√£ Lo·∫°i</th>
                        <th>Lo·∫°i Ph√≤ng</th>
                        <th>S·ªë Ph√≤ng</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>Gi√° Ph√≤ng</th>
                    </tr>
                </thead>
                <tbody id="ketQuaPhong"></tbody>
            </table>
        </div>
    </div>

    <script>
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        function timKiemKhachHang() {
            let ten = document.getElementById("ten_khach_hang").value.trim();
            let startDate = document.getElementById("start_date").value;
            let endDate = document.getElementById("end_date").value;
            let orderType = document.getElementById("sortTenKhachHang").value === "tenAZ" ? "ASC" : "DESC";

            let requestBody = { orderType, customerName: ten };

            if (startDate) requestBody.startDate = startDate;
            if (endDate) requestBody.endDate = endDate;

            fetch('http://127.0.0.1:5000/get-customers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) throw new Error(`L·ªói API: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("D·ªØ li·ªáu API tr·∫£ v·ªÅ:", data);

                let table = document.getElementById("ketQuaKhachHang");
                table.innerHTML = ""; // X√≥a n·ªôi dung c≈©

                if (!Array.isArray(data) || data.length === 0) {
                    table.innerHTML = "<tr><td colspan='7'>Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng</td></tr>";
                    return;
                }

                data.forEach(kh => {
                    let ngayNhan = kh.NgayNhan ? new Date(kh.NgayNhan).toLocaleDateString("vi-VN") : "Kh√¥ng c√≥ d·ªØ li·ªáu";
                    let ngayTra = kh.NgayTra ? new Date(kh.NgayTra).toLocaleDateString("vi-VN") : "Kh√¥ng c√≥ d·ªØ li·ªáu";

                    table.innerHTML += `<tr>
                        <td>${kh.MaPhong || "N/A"}</td>
                        <td>${kh.MaThue || "N/A"}</td>
                        <td>${kh.TenKhachHang || "Kh√¥ng r√µ"}</td>
                        <td>${kh.SoDienThoai || "Kh√¥ng c√≥ th√¥ng tin"}</td>
                        <td>${ngayNhan}</td>
                        <td>${ngayTra}</td>
                        <td>${kh.TenLoai || "Ch∆∞a c·∫≠p nh·∫≠t"}</td>
                    </tr>`;
                });
            })
            .catch(error => {
                console.error('L·ªói khi l·∫•y d·ªØ li·ªáu kh√°ch h√†ng:', error);
                document.getElementById("ketQuaKhachHang").innerHTML = "<tr><td colspan='7'>L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>";
            });
        }



        function timKiemNhanVien() {
            const tenNhanVien = document.getElementById('ten_nhan_vien').value.trim();
            const soDienThoai = document.getElementById('sdt_nhan_vien').value.trim();
            
            const payload = {
                tenNhanVien: tenNhanVien || null, 
                soDienThoai: soDienThoai || null
            };

            fetch('http://127.0.0.1:5000/get-employees', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                hienThiKetQua(data);
            })
            .catch(error => {
                console.error('L·ªói khi t√¨m ki·∫øm nh√¢n vi√™n:', error);
            });
        }

        function hienThiKetQua(data) {
            const ketQuaNhanVien = document.getElementById('ketQuaNhanVien');
            ketQuaNhanVien.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©

            if (!data || data.length === 0) {
                ketQuaNhanVien.innerHTML = '<tr><td colspan="4">Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o</td></tr>';
                return;
            }

            data.forEach(nv => {
                let ngaySinh = nv.NgaySinh ? new Date(nv.NgaySinh).toLocaleDateString("vi-VN") : "Kh√¥ng c√≥ d·ªØ li·ªáu";
                const row = `<tr>
                    <td>${nv.MaNhanVien}</td>
                    <td>${nv.HoTen}</td>
                    <td>${ngaySinh}</td>
                    <td>${nv.SoDienThoai}</td>
                </tr>`;
                ketQuaNhanVien.innerHTML += row;
            });
        }

        async function timKiemPhong() {
        const soPhong = document.getElementById("so_phong").value.trim();
        const loaiPhong = document.getElementById("loai_phong").value.trim();
        let trangThai = document.getElementById("trangThai").value.trim(); 

        if (trangThai === "T·∫•t c·∫£") trangThai = "";
        else if (trangThai === "trong") trangThai = "Tr·ªëng"; 

        let payload = { soPhong: soPhong || null, tenLoai: loaiPhong || null, trangThai };

        // Debug log
        console.log("üì§ Gi√° tr·ªã trangThai tr∆∞·ªõc khi g·ª≠i API:", trangThai);
        console.log("üì§ Payload g·ª≠i API:", payload);

        try {
            const response = await fetch("http://127.0.0.1:5000/get-room-list", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error(`L·ªói API: ${response.status}`);

            const data = await response.json();
            if (!data.success) throw new Error(data.message || "C√≥ l·ªói x·∫£y ra t·ª´ API");

            console.log("D·ªØ li·ªáu nh·∫≠n t·ª´ API:", data.data);
            hienThiKetQuaPhong(data.data);
        } catch (error) {
            console.error("L·ªói khi t√¨m ki·∫øm ph√≤ng:", error);
            document.getElementById("ketQuaPhong").innerHTML =
                "<tr><td colspan='6'>L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>";
            }
        }

        function hienThiKetQuaPhong(data) {
            const ketQuaPhong = document.getElementById("ketQuaPhong");
            ketQuaPhong.innerHTML = ""; // X√≥a k·∫øt qu·∫£ c≈©

            console.log(" D·ªØ li·ªáu tr∆∞·ªõc khi hi·ªÉn th·ªã:", data); // Ki·ªÉm tra console

            if (!Array.isArray(data) || data.length === 0) {
                ketQuaPhong.innerHTML =
                    '<tr><td colspan="6">Kh√¥ng t√¨m th·∫•y ph√≤ng n√†o</td></tr>';
                return;
            }

            // Hi·ªÉn th·ªã danh s√°ch ph√≤ng
            data.forEach((phong) => {
                console.log(" Th√™m ph√≤ng v√†o b·∫£ng:", phong); // Debug d·ªØ li·ªáu hi·ªÉn th·ªã

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${phong.MaPhong ?? "N/A"}</td>
                    <td>${phong.MaLoai ?? "N/A"}</td>
                    <td>${phong.TenLoai ?? "Kh√¥ng r√µ"}</td>
                    <td>${phong.SoPhong ?? "Kh√¥ng r√µ"}</td>
                    <td>${phong.TrangThai ?? "Kh√¥ng r√µ"}</td>
                    <td>${phong.GiaPhong ? parseFloat(phong.GiaPhong).toLocaleString("vi-VN") + " VND" : "Kh√¥ng r√µ"}</td>
                `;
                ketQuaPhong.appendChild(row);
            });
        }

        // Xu·∫•t file Excel t·ª´ b·∫£ng HTML
        function exportTableToExcel(tableId, fileName) {
            let table = document.getElementById(tableId);
            if (!table) {
                console.error("B·∫£ng kh√¥ng t·ªìn t·∫°i:", tableId);
                return;
            }

            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(getTableData(table));

            XLSX.utils.book_append_sheet(wb, ws, "Data");

            let excelBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });
            let data = new Blob([excelBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

            saveAs(data, `${fileName}.xlsx`);
        }

        // H√†m l·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng
        function getTableData(table) {
            let data = [];

            // L·∫•y ti√™u ƒë·ªÅ c·ªôt t·ª´ <thead>
            let headers = [];
            let headerRow = table.querySelector("thead tr");
            if (headerRow) {
                let headerCells = headerRow.querySelectorAll("th");
                headerCells.forEach(th => headers.push(th.innerText.trim()));
                data.push(headers); // Th√™m ti√™u ƒë·ªÅ v√†o h√†ng ƒë·∫ßu ti√™n
            }

            // L·∫•y d·ªØ li·ªáu t·ª´ <tbody>
            let rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                let rowData = [];
                row.querySelectorAll("td").forEach(td => rowData.push(td.innerText.trim()));
                data.push(rowData);
            });

            return data;
        }

        function xuatDSKH() {
            exportTableToExcel("bangKhachHang", "DanhSachKhachHang");
        }

        function xuatDSNV() {
            exportTableToExcel("bangNhanVien", "DanhSachNhanVien");
        }

        function xuatDSPhong() {
            exportTableToExcel("bangPhong", "DanhSachPhong");
        }

        function handleLogout() {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            alert("‚úÖ ƒê√£ ƒëƒÉng xu·∫•t!");
            window.location.href = "./trangchu.html"; // Chuy·ªÉn v·ªÅ trang ch·ªß
        }
    </script>
</body>
</html>
